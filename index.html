<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Anthems | WLAUMC Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; }
        .date-card:hover { transform: translateY(-2px); transition: all 0.2s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Header Section -->
    <header class="bg-white border-b border-slate-200 py-10 px-6">
        <div class="max-w-3xl mx-auto flex flex-col md:flex-row md:items-center justify-between gap-6">
            <div class="flex flex-col md:flex-row items-center gap-6 text-center md:text-left">
                <!-- Church Logo Placeholder -->
                <img 
                    src="wlaumc.png" 
                    alt="WLAUMC Logo" 
                    class="h-20 w-auto object-contain"
                    onerror="this.style.display='none'"
                >
                <div>
                    <h1 class="text-4xl font-extrabold tracking-tight text-slate-900">Choral Selections</h1>
                    <p class="text-lg text-slate-500 font-medium">West Los Angeles United Methodist Church</p>
                </div>
            </div>
            <div class="inline-flex items-center px-4 py-2 bg-blue-50 border border-blue-100 rounded-full text-blue-700 text-sm font-bold self-center md:self-auto">
                Upcoming Schedule
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto px-6 py-12">
        <div id="error-display" class="hidden mb-8"></div>
        
        <div class="mb-12 bg-indigo-600 rounded-3xl p-8 text-white shadow-xl shadow-indigo-200">
            <h2 class="text-xl font-bold mb-2 flex items-center gap-2">
                <span>ðŸŽµ</span> Director's Note
            </h2>
            <p class="text-indigo-100 leading-relaxed">
                Welcome to our upcoming season! Below you'll find the anticipated anthems and introits for our upcoming services. These selections are subject to change.
            </p>
        </div>

        <div id="schedule-container" class="space-y-6">
            <div class="flex flex-col items-center py-20 text-slate-400">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-4"></div>
                <p class="font-medium">Fetching the latest schedule...</p>
            </div>
        </div>
    </main>

    <footer class="max-w-3xl mx-auto px-6 py-12 border-t border-slate-200 text-center text-slate-400 text-sm">
        Updated live from the WLAUMC Choral Library Database
    </footer>

    <script>
        const URLS = {
            DATES_USED: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTECjsITVYtKBiLbd1KDPrGr1CxH_4Apjd_ifLMJibahzdWGZ399TcGK-BvIaUR5BhY8klHzDQzzuyu/pub?gid=946310193&single=true&output=csv',
            ANTHEMS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTECjsITVYtKBiLbd1KDPrGr1CxH_4Apjd_ifLMJibahzdWGZ399TcGK-BvIaUR5BhY8klHzDQzzuyu/pub?gid=1502393631&single=true&output=csv',
            LINKS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTECjsITVYtKBiLbd1KDPrGr1CxH_4Apjd_ifLMJibahzdWGZ399TcGK-BvIaUR5BhY8klHzDQzzuyu/pub?gid=1534744638&single=true&output=csv',
            PEOPLE: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTECjsITVYtKBiLbd1KDPrGr1CxH_4Apjd_ifLMJibahzdWGZ399TcGK-BvIaUR5BhY8klHzDQzzuyu/pub?gid=396850397&single=true&output=csv'
        };

        async function fetchWithDiagnosis(name, url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.text();
            } catch (e) {
                showError(`Failed to fetch <b>${name}</b> data. <a href="${url}" target="_blank" class="underline">Click here to verify the link works in your browser.</a> If it doesn't download a CSV, the sheet isn't published correctly.`);
                throw e;
            }
        }

        function showError(msg) {
            const errDiv = document.getElementById('error-display');
            errDiv.classList.remove('hidden');
            errDiv.innerHTML = `<div class="bg-red-50 border-l-4 border-red-500 p-4 text-red-700 text-sm">${msg}</div>`;
            document.getElementById('schedule-container').innerHTML = '';
        }

        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            if (lines.length === 0) return [];
            
            const headers = splitCSVLine(lines[0]);
            return lines.slice(1).map(line => {
                const values = splitCSVLine(line);
                const obj = {};
                headers.forEach((h, i) => obj[h] = (values[i] || '').trim());
                return obj;
            });
        }

        function splitCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else current += char;
            }
            result.push(current);
            return result;
        }

        async function init() {
            try {
                const [datesTxt, anthemsTxt, linksTxt, peopleTxt] = await Promise.all([
                    fetchWithDiagnosis('Performance Dates', URLS.DATES_USED),
                    fetchWithDiagnosis('Anthem Library', URLS.ANTHEMS),
                    fetchWithDiagnosis('Credits Links', URLS.LINKS),
                    fetchWithDiagnosis('People Directory', URLS.PEOPLE)
                ]);

                const dates = parseCSV(datesTxt);
                const anthems = parseCSV(anthemsTxt);
                const links = parseCSV(linksTxt);
                const people = parseCSV(peopleTxt);

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const filtered = dates.filter(row => {
                    const dateVal = row.DateUsed || row.Date;
                    if (!dateVal) return false;
                    const rowDate = new Date(dateVal);
                    const status = (row.PerformanceStatus || '').toLowerCase();
                    return status === 'anticipated' && rowDate >= today;
                });

                filtered.sort((a, b) => new Date(a.DateUsed || a.Date) - new Date(b.DateUsed || b.Date));

                const enriched = filtered.map(item => {
                    const anthemId = item.AnthemID_Ref;
                    const anthemRecord = anthems.find(a => a.AnthemID === anthemId);
                    const title = anthemRecord ? anthemRecord.Title : anthemId;
                    const associatedPeople = links
                        .filter(l => l.AnthemID_Ref === anthemId)
                        .map(l => {
                            const p = people.find(p => p.PersonID === l.PersonID_Ref);
                            return p ? p.Name : null;
                        }).filter(n => n);

                    return { ...item, AnthemTitle: title, PeopleNames: formatPeopleList(associatedPeople) };
                });

                render(enriched);
            } catch (e) {
                console.error("Initialization failed", e);
            }
        }

        function formatPeopleList(names) {
            if (names.length === 0) return "";
            if (names.length === 1) return `By ${names[0]}`;
            if (names.length === 2) return `By ${names[0]} and ${names[1]}`;
            return `By ${names.slice(0, -1).join(', ')}, and ${names.slice(-1)}`;
        }

        function createCardHtml(item) {
            const dateVal = item.DateUsed || item.Date;
            const d = new Date(dateVal);
            const dateString = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            return `
                <div class="date-card bg-white border border-slate-200 p-8 rounded-3xl shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-start justify-between gap-4">
                        <div class="flex-grow">
                            <p class="text-indigo-600 font-bold text-xs uppercase tracking-widest mb-1">${dateString}</p>
                            <h3 class="text-2xl font-bold text-slate-900 leading-tight">${item.AnthemTitle}</h3>
                            ${item.PeopleNames ? `<p class="text-slate-600 font-semibold mt-1 text-lg">${item.PeopleNames}</p>` : ''}
                            <div class="mt-4 inline-block px-3 py-1 bg-slate-100 rounded-lg text-slate-500 text-xs font-bold uppercase tracking-wide">
                                ${item.Usage || 'Selection'}
                            </div>
                        </div>
                        <div class="hidden md:flex h-12 w-12 bg-slate-50 rounded-2xl items-center justify-center border border-slate-100 text-xl">ðŸŽ¼</div>
                    </div>
                </div>`;
        }

        function render(items) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = items.length ? items.map(item => createCardHtml(item)).join('') : '<div class="text-center py-20 text-slate-400 italic font-medium">No future anthems have been published to the schedule yet.</div>';
        }

        window.onload = init;
    </script>
</body>
</html>
